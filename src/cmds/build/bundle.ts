import browserify from 'browserify';
import { YargsArgs } from '../../types/yargs';
import { writeError } from '../../utils/misc';
import { createBundleStream, canCloseStream } from './bundleUtils';

/**
 * Builds a Snap bundle JSON file from its JavaScript source.
 *
 * @param src - The source file path
 * @param dest - The destination file path
 * @param argv - arguments as an object generated by yargs
 * @param argv.sourceMaps - Whether to output sourcemaps
 * @param argv.stripComments - Whether to remove comments from code
 */
export function bundle(src: string, dest: string, argv: YargsArgs) {

  const { sourceMaps: debug } = argv;

  try {
    const bundleStream = createBundleStream(dest);
    browserify(src, { debug })
      .bundle(async (bundleError, bundleBuffer: Buffer) => canCloseStream(bundleError, bundleBuffer, bundleStream, src, dest));
    return true;
  } catch (error) {
    writeError('', 'error: ', error.message);
    return false;
  }
}
